name: Build Modular RSS Server Image

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest   
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up QEMU for ARM64 builds
        uses: docker/setup-qemu-action@v2
        with:
          platforms: all

      - name: Install latest melange and apko
        run: |
          install_latest_release() {
            TOOL_NAME=$1
            GH_REPO=$2
            ARCH="linux_amd64"
      
            echo "Fetching latest release for $TOOL_NAME..."
            LATEST=$(curl -s https://api.github.com/repos/${GH_REPO}/releases/latest | jq -r '.tag_name')
            TARBALL="${TOOL_NAME}_${LATEST#v}_${ARCH}.tar.gz"
            URL="https://github.com/${GH_REPO}/releases/download/${LATEST}/${TARBALL}"
      
            echo "Downloading $TOOL_NAME from $URL"
            curl -sL "$URL" -o ${TOOL_NAME}.tar.gz
            tar -xzf ${TOOL_NAME}.tar.gz

            BINARY_PATH=$(find . -type f -name "$TOOL_NAME" -executable | head -n 1)
            if [ -z "$BINARY_PATH" ]; then
              echo "❌ Could not find binary '$TOOL_NAME' in archive"
              exit 1
            fi
            
            sudo install -m 0755 "$BINARY_PATH" /usr/local/bin/$TOOL_NAME
            echo "✅ Installed $TOOL_NAME to /usr/local/bin"
          }
      
          sudo apt-get update && sudo apt-get install -y jq
      
          install_latest_release melange chainguard-dev/melange
          install_latest_release apko chainguard-dev/apko

      - name: Verify CLI tools
        run: |
          echo "Listing /usr/local/bin:"
          ls -lah /usr/local/bin

          echo "PATH is: $PATH"
          env | grep PATH
          
          echo "Verifying melange..."
          if ! command -v melange >/dev/null; then
            echo "❌ melange not found in PATH"
            exit 1
          fi
          melange version
      
          echo "Verifying apko..."
          if ! command -v apko >/dev/null; then
            echo "❌ apko not found in PATH"
            exit 1
          fi
          apko version

      - name: Generate cache buster timestamp
        id: cachebuster
        run: echo "BUSTER=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Cache Python wheels
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip/wheels
          key: pip-wheels-${{ runner.os }}-${{ hashFiles('melange/*.yaml', 'requirements.txt') }}-${{ env.BUSTER }}
          restore-keys: |
            pip-wheels-${{ runner.os }}-

      - name: Cache melange build output
        uses: actions/cache@v3
        with:
          path: packages
          key: melange-packages-${{ runner.os }}-${{ hashFiles('melange/*.yaml') }}-${{ env.BUSTER }}
          restore-keys: |
            melange-packages-${{ runner.os }}-

      - name: Generate signing key for this build
        run: |
          melange keygen melange/melange.rsa

      - name: Build all Python packages with melange
        run: |
          sudo apt-get install -y parallel
          mkdir -p packages/x86_64 packages/aarch64

          find melange -name '*.yaml' | parallel -j 4 'melange build {} --arch x86_64 --out-dir packages/x86_64 --signing-key melange/melange.rsa --runner docker || true'
          find melange -name '*.yaml' | parallel -j 1 'melange build {} --arch aarch64 --out-dir packages/aarch64 --signing-key melange/melange.rsa --runner docker || true'

      - name: Index built packages for apko
        run: |
          melange index packages/x86_64
          melange index packages/aarch64          

      - name: Copy application source into /app
        run: |
          mkdir -p app
          cp app.py config.py fetch_functions.py get_latest_release.py product_utils.py app/

      - name: Build container images for both archs with apko
        run: |
          apko build --arch x86_64 apko/apko.yaml rss-server rss-server-amd64.tar
          apko build --arch aarch64 apko/apko.yaml rss-server rss-server-arm64.tar

      - name: Load and tag both images
        run: |
          docker load < rss-server-amd64.tar
          docker tag rss-server ghcr.io/${{ github.repository_owner }}/rss-server:amd64

          docker load < rss-server-arm64.tar
          docker tag rss-server ghcr.io/${{ github.repository_owner }}/rss-server:arm64

      - name: Push individual architecture images
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker push ghcr.io/${{ github.repository_owner }}/rss-server:amd64
          docker push ghcr.io/${{ github.repository_owner }}/rss-server:arm64

      - name: Create and push multi-arch manifest
        run: |
          docker manifest create ghcr.io/${{ github.repository_owner }}/rss-server:latest \
            ghcr.io/${{ github.repository_owner }}/rss-server:amd64 \
            ghcr.io/${{ github.repository_owner }}/rss-server:arm64

          docker manifest push ghcr.io/${{ github.repository_owner }}/rss-server:latest

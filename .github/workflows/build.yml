name: Build Modular RSS Server Image

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install latest melange and apko
        run: |
          install_latest_release() {
            TOOL_NAME=$1
            GH_REPO=$2
            ARCH="linux_amd64"
      
            LATEST=$(curl -s https://api.github.com/repos/${GH_REPO}/releases/latest | jq -r '.tag_name')
            TARBALL="${TOOL_NAME}_${LATEST#v}_${ARCH}.tar.gz"
            URL="https://github.com/${GH_REPO}/releases/download/${LATEST}/${TARBALL}"
      
            echo "Downloading $TOOL_NAME $LATEST from $URL"
            curl -sL "$URL" | tar xz
            sudo mv $TOOL_NAME /usr/local/bin/
            chmod +x /usr/local/bin/$TOOL_NAME
          }
      
          sudo apt-get update && sudo apt-get install -y jq
      
          install_latest_release melange chainguard-dev/melange
          install_latest_release apko chainguard-dev/apko

      - name: Build all Python packages with melange
        run: |
          mkdir -p packages
          for arch in x86_64 aarch64; do
            for f in .github/melange/*.yaml; do
              melange build $f --arch $arch --out-dir packages/$arch --signing-key .github/melange/melange.rsa || true
            done
          done

      - name: Build container image with apko
        run: |
          apko build .github/apko/apko.yaml rss-server.tar
          docker load < rss-server.tar

      - name: Push to GitHub Container Registry
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker tag rss-server ghcr.io/${{ github.repository_owner }}/rss-server:latest
          docker push ghcr.io/${{ github.repository_owner }}/rss-server:latest
